name: Test

on:
  pull_request:
    types:
    - opened
    - synchronize
    - labeled
    - reopened
    paths:
    - .github/workflows/test.yml
  pull_request_target:
    types:
    - opened
    - synchronize
    - labeled
    - reopened
    paths:
    - tools/**
  workflow_dispatch:

jobs:

  test:
    name: Test
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request' || ( github.event_name == 'pull_request_target' && contains(github.event.pull_request.labels.*.name, 'lgtm') )
    steps:

    - name: Checkout code
      uses: actions/checkout@v3

    - name: Test
      env:
        DOCKER_BUILDKIT: 1
      run: |
        echo "Test"

  un-lgtm:
    name: Unlaben LGTM
    needs:
    - test
    runs-on: ubuntu-22.04
    steps:

    - name: Unlabel
      env:
        PR: ${{ github.event.pull_request.number }}
      run: |
        curl -s -v -L \
            -X DELETE \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR}/labels/lgtm
